const fs = require('fs')
const { getInputFiles } = require('./utils')

module.exports = function ({ path }) {
  return {
    name: 'rollup-plugin-esm-entry', // this name will show up in warnings and errors
    writeBundle() {
      const filenames = Object.keys(getInputFiles())
      const importClauses = filenames
        .map((filename) => `import ${filename} from './${filename}.js'`)
        .join('\n')
      const modulesStr = `{\n ${filenames.join(',\n')}\n }`
      const exportClause = `export ${modulesStr}`
      const exportDefaultClause = `export default ${modulesStr}`
      const tip = '/* generated by script */'
      const file = [tip, importClauses, exportClause, exportDefaultClause].join(
        '\n'
      )
      fs.writeFileSync(path, file)
    },
  }
}
